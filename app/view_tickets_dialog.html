<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Data Display</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }
    </style>
    <!-- Include the Freshdesk SDK script -->
    <script src="https://static.freshdev.io/fdk/2.0/assets/fresh_client.js"></script>
</head>
<body>

<table>
    <thead>
        <tr>
            <th>Order ID</th>
            <th>Full Name</th>
            <th>Email</th>
            <th>Mobile</th>
            <th>Organization</th>
            <th>Product Name</th>
            <th>Status</th>
            <th>Price</th>
        </tr>
    </thead>
    <tbody id="apiData">
        <!-- Data will be populated here -->
    </tbody>
</table>

<script>
  // Initialize the Freshdesk SDK client
  const clientPromise = app.initialized();

  clientPromise.then(async function(client) {
      try {
          // Fetch the current ticket's email using Freshdesk Data API
          const ticketData = await client.data.get('ticket');
          if (ticketData && ticketData.ticket) {
              const email = ticketData.ticket.email;

              // Make the API call using the request template from requests.json
              client.request.invoke('getTicketsFromRepairDesk').then(function(response) {
                  const data = JSON.parse(response.response);
                  populateTable(data.data.ticketData);
              }).catch(function(error) {
                  console.error("There was an error fetching the data:", error);
              });
          }
      } catch (error) {
          console.error("Error initializing the app:", error);
      }
  });

  function populateTable(tickets) {
      const tableBody = document.getElementById('apiData');
      tickets.forEach(ticket => {
          const customer = ticket.summary.customer;
          ticket.devices.forEach(device => {
              const row = document.createElement('tr');
              row.innerHTML = `
                  <td>${ticket.summary.order_id}</td>
                  <td>${customer.fullName}</td>
                  <td>${customer.email}</td>
                  <td>${customer.mobile}</td>
                  <td>${customer.orgonization}</td>
                  <td>${device.repairProdItems[0].name}</td>
                  <td>${device.status.name}</td>
                  <td>${device.price}</td>
              `;
              tableBody.appendChild(row);
          });
      });
  }
</script>


</body>
</html>
